{
  "version": 3,
  "sources": ["../../../src/wallet/index.ts"],
  "sourcesContent": ["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Transaction } from '@mysten/sui/transactions';\nimport { toBase64 } from '@mysten/sui/utils';\nimport type {\n\tStandardConnectFeature,\n\tStandardConnectMethod,\n\tStandardDisconnectFeature,\n\tStandardDisconnectMethod,\n\tStandardEventsFeature,\n\tStandardEventsListeners,\n\tStandardEventsOnMethod,\n\tSuiSignPersonalMessageFeature,\n\tSuiSignPersonalMessageMethod,\n\tSuiSignTransactionBlockFeature,\n\tSuiSignTransactionBlockMethod,\n\tSuiSignTransactionFeature,\n\tSuiSignTransactionMethod,\n\tWallet,\n} from '@mysten/wallet-standard';\nimport { getWallets, ReadonlyWalletAccount, SUI_MAINNET_CHAIN } from '@mysten/wallet-standard';\nimport type { Emitter } from 'mitt';\nimport mitt from 'mitt';\n\nimport { DEFAULT_STASHED_ORIGIN, StashedPopup } from './channel/index.js';\nimport type { StashedSupportedNetwork } from './types.js';\n\ntype WalletEventsMap = {\n\t[E in keyof StandardEventsListeners]: Parameters<StandardEventsListeners[E]>[0];\n};\n\nconst STASHED_RECENT_ADDRESS_KEY = 'stashed:recentAddress';\n\nexport const STASHED_WALLET_NAME = 'Stashed' as const;\n\nexport class StashedWallet implements Wallet {\n\t#events: Emitter<WalletEventsMap>;\n\t#accounts: ReadonlyWalletAccount[];\n\t#origin: string;\n\t#name: string;\n\t#network: StashedSupportedNetwork;\n\n\tget name() {\n\t\treturn STASHED_WALLET_NAME;\n\t}\n\n\tget icon() {\n\t\treturn 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgZmlsbD0ibm9uZSI+PHJlY3Qgd2lkdGg9IjU0IiBoZWlnaHQ9IjU0IiB4PSIxIiB5PSIxIiBmaWxsPSIjNTE5REU5IiByeD0iMjciLz48cmVjdCB3aWR0aD0iNTQiIGhlaWdodD0iNTQiIHg9IjEiIHk9IjEiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIiByeD0iMjciLz48cGF0aCBmaWxsPSIjMDAwIiBkPSJNMTguMzUzIDM1LjA2NGMuOTIxIDMuNDM4IDQuMzYzIDYuNTUxIDExLjQ4MyA0LjY0NCA2Ljc5NC0xLjgyMSAxMS4wNTItNy40MSA5Ljk0OC0xMS41My0uMzgxLTEuNDIzLTEuNTMtMi4zODctMy4zLTIuMjNsLTE1LjgzMiAxLjMyYy0uOTk3LjA3Ni0xLjQ1NC0uMDg4LTEuNzE4LS43MTYtLjI1Ni0uNTk5LS4xMS0xLjI0MSAxLjA5NC0xLjg1bDEyLjA0OC02LjE4M2MuOTI0LS40NyAxLjUzOS0uNjY2IDIuMTAxLS40NjguMzUyLjEyOC41ODQuNjM4LjM3MSAxLjI2N2wtLjc4MSAyLjMwNmMtLjk1OSAyLjgzIDEuMDk0IDMuNDg4IDIuMjUgMy4xNzggMS43NTEtLjQ2OSAyLjE2My0yLjEzNiAxLjU5OS00LjI0LTEuNDMtNS4zMzctNy4wOS02LjE3LTEyLjIyMy00Ljc5Ni01LjIyMiAxLjQtOS43NDggNS42My04LjM2NiAxMC43ODkuMzI1IDEuMjE1IDEuNDQ0IDIuMTg2IDIuNzQgMi4xNTdsMS45NzgtLjAwNWMuNDA3LS4wMS4yNi4wMjQgMS4wNDYtLjA0MS43ODQtLjA2NSAyLjg4LS4zMjMgMi44OC0uMzIzbDEwLjI4Ni0xLjE2NC4yNjUtLjAzOGMuNjAyLS4xMDMgMS4wNTYuMDUzIDEuNDQuNzE1LjU3Ni45OTEtLjMwMiAxLjczOC0xLjM1MiAyLjYzM2wtLjA4NS4wNzItOS4wNDEgNy43OTJjLTEuNTUgMS4zMzctMi42MzkuODM0LTMuMDItLjU4OWwtMS4zNS01LjA0Yy0uMzM0LTEuMjQ0LTEuNTUtMi4yMjEtMi45NzQtMS44NC0xLjc4LjQ3Ny0xLjkyNCAyLjU1LTEuNDg3IDQuMThaIi8+PC9zdmc+Cg==' as const;\n\t}\n\n\tget version() {\n\t\treturn '1.0.0' as const;\n\t}\n\n\tget chains() {\n\t\treturn [SUI_MAINNET_CHAIN] as const;\n\t}\n\n\tget accounts() {\n\t\treturn this.#accounts;\n\t}\n\n\tget features(): StandardConnectFeature &\n\t\tStandardDisconnectFeature &\n\t\tStandardEventsFeature &\n\t\tSuiSignTransactionBlockFeature &\n\t\tSuiSignTransactionFeature &\n\t\tSuiSignPersonalMessageFeature {\n\t\treturn {\n\t\t\t'standard:connect': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tconnect: this.#connect,\n\t\t\t},\n\t\t\t'standard:disconnect': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tdisconnect: this.#disconnect,\n\t\t\t},\n\t\t\t'standard:events': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\ton: this.#on,\n\t\t\t},\n\t\t\t'sui:signTransactionBlock': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tsignTransactionBlock: this.#signTransactionBlock,\n\t\t\t},\n\t\t\t'sui:signTransaction': {\n\t\t\t\tversion: '2.0.0',\n\t\t\t\tsignTransaction: this.#signTransaction,\n\t\t\t},\n\t\t\t'sui:signPersonalMessage': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tsignPersonalMessage: this.#signPersonalMessage,\n\t\t\t},\n\t\t};\n\t}\n\n\tconstructor({\n\t\tname,\n\t\tnetwork,\n\t\taddress,\n\t\torigin = DEFAULT_STASHED_ORIGIN,\n\t}: {\n\t\tname: string;\n\t\tnetwork: StashedSupportedNetwork;\n\t\torigin?: string;\n\t\taddress?: string | null;\n\t}) {\n\t\tthis.#accounts = [];\n\t\tthis.#events = mitt();\n\t\tthis.#origin = origin;\n\t\tthis.#name = name;\n\t\tthis.#network = network;\n\n\t\tif (address) {\n\t\t\tthis.#setAccount(address);\n\t\t}\n\t}\n\n\t#signTransactionBlock: SuiSignTransactionBlockMethod = async ({ transactionBlock, account }) => {\n\t\ttransactionBlock.setSenderIfNotSet(account.address);\n\n\t\tconst data = transactionBlock.serialize();\n\n\t\tconst popup = new StashedPopup({\n\t\t\tname: this.#name,\n\t\t\torigin: this.#origin,\n\t\t\tnetwork: this.#network,\n\t\t});\n\n\t\tconst response = await popup.send({\n\t\t\ttype: 'sign-transaction-block',\n\t\t\tdata,\n\t\t\taddress: account.address,\n\t\t});\n\n\t\treturn {\n\t\t\ttransactionBlockBytes: response.bytes,\n\t\t\tsignature: response.signature,\n\t\t};\n\t};\n\n\t#signTransaction: SuiSignTransactionMethod = async ({ transaction, account }) => {\n\t\tconst popup = new StashedPopup({\n\t\t\tname: this.#name,\n\t\t\torigin: this.#origin,\n\t\t\tnetwork: this.#network,\n\t\t});\n\n\t\tconst tx = Transaction.from(await transaction.toJSON());\n\t\ttx.setSenderIfNotSet(account.address);\n\n\t\tconst data = tx.serialize();\n\n\t\tconst response = await popup.send({\n\t\t\ttype: 'sign-transaction-block',\n\t\t\tdata,\n\t\t\taddress: account.address,\n\t\t});\n\n\t\treturn {\n\t\t\tbytes: response.bytes,\n\t\t\tsignature: response.signature,\n\t\t};\n\t};\n\n\t#signPersonalMessage: SuiSignPersonalMessageMethod = async ({ message, account }) => {\n\t\tconst popup = new StashedPopup({\n\t\t\tname: this.#name,\n\t\t\torigin: this.#origin,\n\t\t\tnetwork: this.#network,\n\t\t});\n\t\tconst bytes = toBase64(message);\n\n\t\tconst response = await popup.send({\n\t\t\ttype: 'sign-personal-message',\n\t\t\tbytes,\n\t\t\taddress: account.address,\n\t\t});\n\n\t\treturn {\n\t\t\tbytes,\n\t\t\tsignature: response.signature,\n\t\t};\n\t};\n\n\t#on: StandardEventsOnMethod = (event, listener) => {\n\t\tthis.#events.on(event, listener);\n\t\treturn () => this.#events.off(event, listener);\n\t};\n\n\t#setAccount(address?: string) {\n\t\tif (address) {\n\t\t\tthis.#accounts = [\n\t\t\t\tnew ReadonlyWalletAccount({\n\t\t\t\t\taddress,\n\t\t\t\t\tchains: [SUI_MAINNET_CHAIN],\n\t\t\t\t\tfeatures: ['sui:signTransactionBlock', 'sui:signPersonalMessage'],\n\t\t\t\t\t// NOTE: Stashed doesn't support getting public keys, and zkLogin accounts don't have meaningful public keys anyway\n\t\t\t\t\tpublicKey: new Uint8Array(),\n\t\t\t\t}),\n\t\t\t];\n\n\t\t\tlocalStorage.setItem(STASHED_RECENT_ADDRESS_KEY, address);\n\t\t} else {\n\t\t\tthis.#accounts = [];\n\t\t}\n\n\t\tthis.#events.emit('change', { accounts: this.accounts });\n\t}\n\n\t#connect: StandardConnectMethod = async (input) => {\n\t\tif (input?.silent) {\n\t\t\tconst address = localStorage.getItem(STASHED_RECENT_ADDRESS_KEY);\n\n\t\t\tif (address) {\n\t\t\t\tthis.#setAccount(address);\n\t\t\t}\n\n\t\t\treturn { accounts: this.accounts };\n\t\t}\n\n\t\tconst popup = new StashedPopup({\n\t\t\tname: this.#name,\n\t\t\torigin: this.#origin,\n\t\t\tnetwork: this.#network,\n\t\t});\n\n\t\tconst response = await popup.send({\n\t\t\ttype: 'connect',\n\t\t});\n\n\t\tif (!('address' in response)) {\n\t\t\tthrow new Error('Unexpected response');\n\t\t}\n\n\t\tthis.#setAccount(response.address);\n\n\t\treturn { accounts: this.accounts };\n\t};\n\n\t#disconnect: StandardDisconnectMethod = async () => {\n\t\tlocalStorage.removeItem(STASHED_RECENT_ADDRESS_KEY);\n\t\tthis.#setAccount();\n\t};\n}\n\nexport function registerStashedWallet(\n\tname: string,\n\t{\n\t\torigin,\n\t\tnetwork = 'mainnet',\n\t}: {\n\t\torigin?: string;\n\t\tnetwork?: StashedSupportedNetwork;\n\t} = {},\n) {\n\tconst wallets = getWallets();\n\n\tlet addressFromRedirect: string | null = null;\n\ttry {\n\t\tconst params = new URLSearchParams(window.location.search);\n\t\taddressFromRedirect = params.get('stashed_address') || params.get('zksend_address');\n\t} catch {\n\t\t// Ignore errors\n\t}\n\n\tconst wallet = new StashedWallet({\n\t\tname,\n\t\tnetwork,\n\t\torigin,\n\t\taddress: addressFromRedirect,\n\t});\n\n\tconst unregister = wallets.register(wallet);\n\n\treturn {\n\t\twallet,\n\t\tunregister,\n\t\taddressFromRedirect,\n\t};\n}\n"],
  "mappings": "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",
  "names": ["mitt"]
}

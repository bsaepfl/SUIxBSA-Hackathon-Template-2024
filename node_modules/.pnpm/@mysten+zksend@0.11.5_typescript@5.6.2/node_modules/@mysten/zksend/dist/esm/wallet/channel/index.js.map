{
  "version": 3,
  "sources": ["../../../../src/wallet/channel/index.ts"],
  "sourcesContent": ["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nimport type { InferOutput } from 'valibot';\nimport { parse, safeParse } from 'valibot';\n\nimport { withResolvers } from '../../utils/withResolvers.js';\nimport type { StashedSupportedNetwork } from '../types.js';\nimport type { StashedRequestData, StashedResponsePayload, StashedResponseTypes } from './events.js';\nimport { StashedRequest, StashedResponse } from './events.js';\n\nexport const DEFAULT_STASHED_ORIGIN = 'https://getstashed.com';\n\nexport { StashedRequest, StashedResponse };\n\nexport class StashedPopup {\n\t#popup: Window;\n\n\t#id: string;\n\t#origin: string;\n\t#name: string;\n\t#network: StashedSupportedNetwork;\n\n\t#promise: Promise<unknown>;\n\t#resolve: (data: unknown) => void;\n\t#reject: (error: Error) => void;\n\n\t#interval: ReturnType<typeof setInterval> | null = null;\n\n\tconstructor({\n\t\tname,\n\t\tnetwork,\n\t\torigin = DEFAULT_STASHED_ORIGIN,\n\t}: {\n\t\tname: string;\n\t\tnetwork: StashedSupportedNetwork;\n\t\torigin?: string;\n\t}) {\n\t\tconst popup = window.open('about:blank', '_blank');\n\n\t\tif (!popup) {\n\t\t\tthrow new Error('Failed to open new window');\n\t\t}\n\t\tthis.#popup = popup;\n\n\t\tthis.#id = crypto.randomUUID();\n\t\tthis.#origin = origin;\n\t\tthis.#name = name;\n\t\tthis.#network = network;\n\n\t\tconst { promise, resolve, reject } = withResolvers();\n\t\tthis.#promise = promise;\n\t\tthis.#resolve = resolve;\n\t\tthis.#reject = reject;\n\n\t\tthis.#interval = setInterval(() => {\n\t\t\ttry {\n\t\t\t\tif (this.#popup.closed) {\n\t\t\t\t\tthis.#cleanup();\n\t\t\t\t\treject(new Error('User closed the Stashed window'));\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// This can error during the login flow, but that's fine.\n\t\t\t}\n\t\t}, 1000);\n\t}\n\n\tsend<T extends StashedRequestData['type']>({\n\t\ttype,\n\t\t...data\n\t}: {\n\t\ttype: T;\n\t} & Extract<StashedRequestData, { type: T }>): Promise<StashedResponseTypes[T]> {\n\t\twindow.addEventListener('message', this.#listener);\n\t\tthis.#popup.location.assign(\n\t\t\t`${this.#origin}/dapp/${type}?${new URLSearchParams({\n\t\t\t\tid: this.#id,\n\t\t\t\torigin: window.origin,\n\t\t\t\tnetwork: this.#network,\n\t\t\t\tname: this.#name,\n\t\t\t})}${data ? `#${new URLSearchParams(data as never)}` : ''}`,\n\t\t);\n\n\t\treturn this.#promise as Promise<StashedResponseTypes[T]>;\n\t}\n\n\tclose() {\n\t\tthis.#cleanup();\n\t\tthis.#popup.close();\n\t}\n\n\t#listener = (event: MessageEvent) => {\n\t\tif (event.origin !== this.#origin) {\n\t\t\treturn;\n\t\t}\n\t\tconst { success, output } = safeParse(StashedResponse, event.data);\n\t\tif (!success || output.id !== this.#id) return;\n\n\t\tthis.#cleanup();\n\n\t\tif (output.payload.type === 'reject') {\n\t\t\tthis.#reject(new Error('User rejected the request'));\n\t\t} else if (output.payload.type === 'resolve') {\n\t\t\tthis.#resolve(output.payload.data);\n\t\t}\n\t};\n\n\t#cleanup() {\n\t\tif (this.#interval) {\n\t\t\tclearInterval(this.#interval);\n\t\t\tthis.#interval = null;\n\t\t}\n\t\twindow.removeEventListener('message', this.#listener);\n\t}\n}\n\nexport class StashedHost {\n\t#request: InferOutput<typeof StashedRequest>;\n\n\tconstructor(request: InferOutput<typeof StashedRequest>) {\n\t\tif (typeof window === 'undefined' || !window.opener) {\n\t\t\tthrow new Error(\n\t\t\t\t'StashedHost can only be used in a window opened through `window.open`. `window.opener` is not available.',\n\t\t\t);\n\t\t}\n\n\t\tthis.#request = request;\n\t}\n\n\tstatic fromUrl(url: string = window.location.href) {\n\t\tconst parsed = new URL(url);\n\n\t\tconst urlHashData = parsed.hash\n\t\t\t? Object.fromEntries(\n\t\t\t\t\t[...new URLSearchParams(parsed.hash.slice(1))].map(([key, value]) => [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tvalue.replace(/ /g, '+'),\n\t\t\t\t\t]),\n\t\t\t\t)\n\t\t\t: {};\n\n\t\tconst request = parse(StashedRequest, {\n\t\t\tid: parsed.searchParams.get('id'),\n\t\t\torigin: parsed.searchParams.get('origin'),\n\t\t\tname: parsed.searchParams.get('name'),\n\t\t\tpayload: {\n\t\t\t\ttype: parsed.pathname.split('/').pop(),\n\t\t\t\t...urlHashData,\n\t\t\t},\n\t\t});\n\n\t\treturn new StashedHost(request);\n\t}\n\n\tgetRequestData() {\n\t\treturn this.#request;\n\t}\n\n\tsendMessage(payload: StashedResponsePayload) {\n\t\twindow.opener.postMessage(\n\t\t\t{\n\t\t\t\tid: this.#request.id,\n\t\t\t\tsource: 'zksend-channel',\n\t\t\t\tpayload,\n\t\t\t} satisfies StashedResponse,\n\t\t\tthis.#request.origin,\n\t\t);\n\t}\n\n\tclose(payload?: StashedResponsePayload) {\n\t\tif (payload) {\n\t\t\tthis.sendMessage(payload);\n\t\t}\n\t\twindow.close();\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
